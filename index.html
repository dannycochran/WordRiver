<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<title>A River of Twitter Data</title>
<script src="lib/d3.v2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="lib/jquery.tipsy.js"></script>          
<script type="text/javascript" src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>

<link rel="stylesheet" href="styles/style.css" type="text/css" /> 
<link rel="stylesheet" href="styles/tipsy.css" type="text/css" />  
<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />

<div>
  <h1>
  <img src="lib/twitter-bird-white-on-blue1.png"/>
  Activity, Hurricane Sandy
  </h1>
</div>  
</head>
<body>

<script type="text/javascript">

var distanceBins = [["0-50 Miles","Southern New Jersey"],["51-110 Miles","Includes Manhattan"],["111-200 Miles","Includes Washington D.C."],["201-500 Miles","Entire East Coast"],["501-1000 Miles","Midwest Region (including Chicago)"],["1000-3000 Miles","Continental U.S."],["3000+ Miles","Rest of the World excluding U.S."]]
  , fill = d3.scale.category20()
  , jsonData
  , max_extent_width = 5
  , min_extent_width = 5;

var smiley_face_domain = [0.0, 0.00284480033716]
	, positivity_domain = [0.0163966168908, 0.0418471720818]
	, frequency_domain = [0, 0.1]
	, frowny_face_domain = [0.0, 0.00307254196643]
	, objectivity_domain = [0.923212665835, 0.965169775079]
	, negativity_domain = [0.0180826923077, 0.0402922531428];

d3.json("lib/sandyData1.json", function (json) {

jsonData=json;

var margin = {top: 20, right: 15, bottom: 15, left: 105}
  , width = 960 - margin.left - margin.right
  , height = 500 - margin.top - margin.bottom
  , miniHeight = distanceBins.length * 12 + 50
  , mainHeight = height - miniHeight - 50;

x = d3.scale.linear()
  .domain([0,164])
  .range([0, width]);
x1 = d3.scale.linear().range([0, width]);
  
var ext = d3.extent(distanceBins, function(d,i) { return i; });
y1 = d3.scale.linear().domain([ext[0], ext[1] + 1]).range([0, mainHeight]);
y2 = d3.scale.linear().domain([ext[0], ext[1] + 1]).range([0, miniHeight]);

colorScale = d3.scale.linear()
  .domain(positivity_domain)
  .range([50,255]);
    
colorScale1 = d3.scale.linear()
  .domain(positivity_domain)
  .range([1,8]);

wordSizeScale = d3.scale.linear()
  .domain(frequency_domain)
  .range([10,20]);

extentSizeScale = d3.scale.linear()
  .domain([min_extent_width,max_extent_width])
  .range([2,4]);

rectSizeScale = d3.scale.linear()
  .clamp([true])
  .domain([0,15])
  .range([35,35]);

typeFaceScale = d3.scale.linear()
  .domain(objectivity_domain)
  .range([0,3]);

var chart = d3.select('body')
  .append('svg:svg')
  .attr('width', width + margin.right + margin.left+100)
  .attr('height', height + margin.top + margin.bottom)
  .attr('class', 'chart');

chart.append('defs').append('clipPath')
  .attr('id', 'clip')
  .append('rect')
    .attr('width', width)
    .attr('height', mainHeight);

main = chart.append('g')
  .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
  .attr('width', width)
  .attr('height', mainHeight)
  .attr('class', 'main');

mini = chart.append('g')
  .attr('transform', 'translate(' + margin.left + ',' + (mainHeight + 60) + ')')
  .attr('width', width)
  .attr('height', miniHeight)
  .attr('class', 'mini');

// draw the distanceBins for the main chart
main.append('g').selectAll('.laneLines')
  .data(distanceBins)
  .enter().append('line')
  .attr('x1', 0)
  .attr('y1', function(d,i) { return d3.round(y1(i)) + 1; })
  .attr('x2', width)
  .attr('y2', function(d,i) { return d3.round(y1(i)) + 1; })
  .attr('stroke', function(d,i) { return 'lightgray' });

main.append('g').selectAll('.laneText')
  .data(distanceBins)
  .enter().append('text')
  .text(function(d) { return d[0]; })
  .attr('x',-5)
  .attr('y', function(d,i) { return y1(i + .5); })
  .attr('dy', '0.5ex')
  .attr('text-anchor', 'end')
  .attr('class', 'laneText')
  .attr('id', 'laneHover')
  .style('font-family', 'Rockwell')
  .on('mouseover',function() {
	  $('svg #laneHover').tipsy({ 
		gravity: 'nw', 
		html: true, 
		title: function() {
		  var d = this.__data__; 
		  return d[1];
		  }
		})
	});

main.append('text')
    .attr('class', 'x_label')
    .attr('id', 'x_label')
    .attr('text-anchor', 'end')
    .attr('x', width+70)
    .attr('y', mainHeight)
    .style('font-family', 'Rockwell')
    .text('hours from');
main.append('text')
    .attr('class', 'x_label')
    .attr('id', 'x_label')
    .attr('text-anchor', 'end')
    .attr('x', width+70)
    .attr('y', mainHeight + 14)
    .style('font-family', 'Rockwell')
    .text('landfall');

main.append('rect')
    .attr('x', width+10)
    .attr('y', mainHeight - 150)
    .attr('width',40)
    .attr('height',20)
    .style('fill','#4099FF')
main.append('svg:text')
    .attr('id', 'color')
    .attr('x', width+13)
    .attr('y', mainHeight - 136)
    .text('Color')
    .style('font-family', 'Rockwell')
    .style('fill','white')
    .style('font-size',12);
main.append('rect')
    .attr('x', width+10)
    .attr('y', mainHeight - 180)
    .attr('width',65)
    .attr('height',20)
    .style('fill','#4099FF')
main.append('svg:text')
    .attr('id', 'typeFace')
    .attr('x', width+13)
    .attr('y', mainHeight - 166)
    .text('Font Type')
    .style('font-family', 'Rockwell')
    .style('fill','white')
    .style('font-size',12);
main.append('rect')
    .attr('x', width+10)
    .attr('y', mainHeight - 120)
    .attr('width',100)
    .attr('height',20)
    .style('fill','#4099FF')
main.append('svg:text')
    .attr('id', 'frequency')
    .attr('x', width+13)
    .attr('y', mainHeight - 106)
    .text('Word Frequency')
    .style('font-family', 'Rockwell')
    .style('fill','white')
    .style('font-size',12);
    

// draw the distanceBins for the mini chart
mini.append('g').selectAll('.laneLines')
  .data(distanceBins)
  .enter().append('line')
  .attr('x1', 0)
  .attr('y1', function(d,i) { return d3.round(y2(i)) + 0.5; })
  .attr('x2', width)
  .attr('y2', function(d,i) { return d3.round(y2(i)) + 0.5; })
  .attr('stroke', function(d) { return d === '' ? 'white' : 'lightgray' });

mini.append('g').selectAll('.laneText')
  .data(distanceBins)
  .enter().append('svg:text')
  .text(function(d) { return d[0]; })
  .attr('x', -10)
  .attr('y', function(d,i) { return y2(i+ 0.5); })
  .attr('dy', '0.5ex')
  .attr('text-anchor', 'end')
  .attr('class', 'laneText');
  
// draw the x axis
xDateAxis = d3.svg.axis()
  .scale(x1)
  .ticks(20)
  .tickSize(15, 0, 0);

x1DateAxis = d3.svg.axis()
  .scale(x)
  .ticks(20)
  .tickSize(15, 0, 0);

main.append('g')
  .attr('transform', 'translate(0,' + mainHeight + ')')
  .attr('class', 'main axis')
  .call(xDateAxis);
  
mini.append('g')
  .attr('transform', 'translate(0,125)')
  .attr('class', 'axis')
  .call(x1DateAxis)
  .selectAll('text')
    .attr('dx', 9)
    .attr('dy', 12);

// draw the items
itemRects = main.append('g')
  .attr('clip-path', 'url(#clip)');

mini.append('g').selectAll('miniItems')
  .data(json)
  .enter().append('rect')
  .attr('class', function(d) { return 'miniItem '; })
  .attr("x",function(d,i) {return x(d.time_bin)})
  .attr("y",function(d) {return y2(d.dist_bin+.08)})
  .attr("width",x(2)-x(1))
  .attr("height",y2(1)*.5)
  .style('fill', function(d) {            
        var b = Math.round(colorScale(d.positivity));
        return "rgb(25,50," + b + ")";
        });
// draw the selection area
brush = d3.svg.brush()
  .x(x)
  .extent([min_extent_width-5, 5])
  .on("brush", display);

mini.append('g')
  .attr('class', 'x brush')
  .call(brush)
  .selectAll('rect')
  .attr('y', 1)
  .attr('id','brushHover')
  .attr('height', miniHeight - 1);

mini.selectAll('rect.background').remove();
display();
});

function display () {

  var rects, labels
    , minExtent = brush.extent()[0]
    , maxExtent = brush.extent()[1];
  var extentWidth = maxExtent - minExtent;
    if (extentWidth > max_extent_width)
      maxExtent = minExtent + max_extent_width;
    if (extentWidth < min_extent_width)
      maxExtent = minExtent + min_extent_width;
  var visItems = jsonData.filter(function (d) {return d.time_bin < maxExtent && d.time_bin > minExtent});
  mini.select('.brush').call(brush.extent([minExtent, maxExtent])); 

  x1.domain([minExtent, maxExtent]);
  
  if ((maxExtent - minExtent) > 5) {
    xDateAxis.ticks(10);
  }
  else if ((maxExtent - minExtent) > 10) {
    xDateAxis.ticks(20);
  }
  else {
    xDateAxis.ticks(5);
  }

  // update the axis

  main.select('.main.axis').call(xDateAxis)
    .selectAll('text')
      .attr('dx', 5)
      .attr('dy', 12);

  // upate the item rects
  rects = itemRects.selectAll('rect')
    .data(visItems, function (d,i) { return i; })
    .attr('x', function(d) { return x1(d.time_bin-0.975); })
    .attr('y', function(d) { return y1(d.dist_bin) + .1 * y1(1) + 0.5; })
    .attr('width', function(d) { 
      if ((maxExtent - minExtent) <= 5) {
    	return x(rectSizeScale(d.word.length)) 
    	}
      else if ((maxExtent - minExtent) >= 5) {
		return x(rectSizeScale(d.word.length*(maxExtent-minExtent-5)));
		}
	})  
	
  rects.enter().append('svg:rect')
    .attr('x', function(d) { return x1(d.time_bin-0.975); })
    .attr('y', function(d) { return y1(d.dist_bin) + .1 * y1(1) + 0.5; })
    .attr('width', function(d) { 
      if ((maxExtent - minExtent) <= 5) {
    	return x(rectSizeScale(d.word.length)) 
    	}
      else {
		return x(rectSizeScale(d.word.length*(maxExtent-minExtent-5)));
		}
	})    
    .attr('height', function(d) { return .8 * y1(1); })
    .style('fill', function(d) {            
        var b = Math.round(colorScale(d.positivity));
        return "rgb(25,50," + b + ")";
    });
    
  rects.exit().remove();

  // update the item labels
  labels = itemRects.selectAll('text')
    .data(visItems, function (d) { return d.word; })
    .attr('x', function(d) { 
    	if ((maxExtent - minExtent) <= 5) {
   			return Math.round(x1(d.time_bin-0.95)); 
   			}
    	else {
   			return Math.round(x1(d.time_bin-1)-x(maxExtent-minExtent-12)); 
   		}
   	})
    .attr('y', function(d) { return y1(d.dist_bin) + .6 * y1(1)})
    .attr('id','hover');

  labels.enter().append('svg:text')
    .text(function (d) { return d.word; })
    .attr('x', function(d) { 
    	if ((maxExtent - minExtent) <= 5) {
   			return Math.round(x1(d.time_bin-0.95)); 
   			}
    	else {
   			return Math.round(x1(d.time_bin)-x(maxExtent-minExtent-12)); 
   		}
   	})
   	.attr('y', function(d) { return y1(d.dist_bin) + .6 * y1(1) })
    .attr('text-anchor', 'start')
    .attr('class', 'itemLabel')
    .attr('id','hover')
    .style('kerning',function(d) {
    	if (typeFaceScale(d.objectivity) < 1) {
    		return 0.5;
    	}
    })
    .style('font-family', function(d) { // add more if/else to ammend objectivity texts
        if (typeFaceScale(d.objectivity) < 1) {
         return 'Impact';
        }
        else if(typeFaceScale(d.objectivity) > 2) {
    		return 'Times New Roman'
    	}
    	else {return 'Rockwell'}
    })
    .style('font-size',function(d) {
    	if (d.word.length >= 8 && wordSizeScale(d.frequency)>=16) { //sloppy, unethical way of resizing data so it doesn't go out of rectangle bounds.
    		return 16;
    	}
    	if ((maxExtent - minExtent) <= 5) {
    		return Math.round(wordSizeScale(d.frequency))
    	}
    	else {
    		return Math.round(wordSizeScale(d.frequency)- extentSizeScale(maxExtent-minExtent));
    	}
    })
    .style('fill','white');
  labels.exit().remove();
  rects.exit().remove();
   
  $('svg #hover').tipsy({ 
	gravity: 'w', 
	html: true, 
	title: function() {
	  var d = this.__data__; 
	  return d.sample_tweet;
	  }
	});
	
  $('svg #x_label').tipsy({ 
	gravity: 'ne', 
	html: true, 
	title: function() {
	  return "0 Hour is LandFall";
	  }
	})
	
  $('svg #typeFace').tipsy({ 
	gravity: 'ne', 
	html: true, 
	title: function() {
	  return "<span style='font-family: Impact'>Impact</span>" + " is highly emotional," + "<br>" + "<span style='font-family: Rockwell'>Rockwell</span>" + " is a normal level of emotion." + "<br>" + "<span style='font-family: Times New Roman; font-weight:bold'>Times New Roman</span>" + " is removed of emotion.";
	  }
	})
  $('svg #color').tipsy({ 
	gravity: 'ne', 
	html: true, 
	title: function() {
	  return "Positivity: Darker shades correlate to higher positivity (NLTK sentiment ratings).";
	  }
	})
  $('svg #frequency').tipsy({ 
	gravity: 'ne', 
	html: true, 
	title: function() {
	  return "Larger fonts correlate to higher relative word frequency.";
	  }
	})

  $('svg #brushHover').tipsy({ 
	gravity: 'sw', 
	html: true, 
	title: function() {
	  return "Move me to scroll through data.";
	  }
	})
	
  $('.tipsy:last').remove();	
};
</script>
</body>
</html>